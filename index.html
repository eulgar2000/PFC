<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Toma de datos</title>


<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="css/micss.css" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />
<script src="phonegap/phonegap-1.4.1.js" type="text/javascript"></script>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>

</head>
<body>
 
<div data-role="page" id="pagina1">
 	  <div data-role="header">  
        <h1>Toma de datos</h1>
      </div>
      <div data-role="content">
     
        <span>Nomina mensual: </span>
   			<table>
      			<tr>
        			<td><input type="number"  value="" id="nominaMensual" name="nominaMensual" class="localStorage"></td>
        			<td><a href="popUp.html" data-rel="dialog" data-role="button" data-transition="pop">?</a></td>
      			</tr>    
    		</table>  
		<span>Otros ingresos: </span>
        <table>
      			<tr>
        			<td><input type="number" value="" id="otrosIngresos" name="otrosIngresos" ></td>
        			<td><a href="popUp1.html" data-rel="dialog" data-role="button" data-transition="pop">?</a></td>
      			</tr>    
    		</table> 		
		<span>Importe de sus deudas: </span>
        <table>
      			<tr>
        			<td><input type="number" value="" id="importeDeudas" name="importeDeudas"></td>
        			<td><a href="popUp3.html" data-rel="dialog" data-role="button" data-transition="pop">?</a></td>
      			</tr>    
    		</table>          
         <span>Total de gastos mensuales: </span>
        <table>
      			<tr>
        			<td><input type="number" value="" id="totalGastosMes" name="totalGastosMes"></td>
        			<td><a href="popUp2.html" data-rel="dialog" data-role="button" data-transition="pop">?</a></td>
      			</tr>    
    		</table> 
      
        <a href=#  data-role=button id=aceptar>Enviar datos</a>
        <a href=#  data-role=button id=analizar_datos>Analizar datos</a>
        <a href=#  data-role=button id=remove> Borrar datos </a>
        
      </div>
      <div data-role="footer">
        <h1>Toma de datos</h1>
      </div>
 </div>
 
<div data-role="page" id="analisis" data-theme="a">
  <div data-role="header">
    <h1>Analisis</h1>
  </div>
  
  <div data-role="content">
  
      <div id="capa1">
      <p>Contenido no cargado</p>
      </div>
      
      <div id="capa2">
      <p>Contenido no cargado</p>
      </div>
      
      <div id="capa3">
      <p>Contenido no cargado</p>
      </div>
      
      <div id="capa4">
      <p>Contenido no cargado</p>
      </div>
 </div>
  
  <div data-role="footer">
    <h4>JVG-UOC-ITIG</h4>
  </div>
</div>

</body>
</html>

<script>

var db = openDatabase ("IG", "1.0", "Ingreos y gastos", 65535);



$("#aceptar").on("click", function (event)
{
	db.transaction (function (transaction) 
	{
			var sql = "CREATE TABLE ingresosgastos " +
				" (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, " +
				"nomina INTEGER, " +
				"ingresos INTEGER, " +
				"deudas INTEGER, " +				 
				"gastosMes INTEGER )"
               
			transaction.executeSql (sql, undefined, function ()
			{ 
			  alert("Tabla creada");
			}, error);
    });
	
	var nomina = $("#nominaMensual").val();
	var ingresos = $("#otrosIngresos").val();
	var deudas= $("#importeDeudas").val();
	var gastosMes=$("#totalGastosMes").val();

	db.transaction (function (transaction) 
	{
		var sql = "SELECT * FROM ingresosgastos";
        transaction.executeSql (sql, undefined,function (transaction, result)
        {
			  if (result.rows.length==null || result.rows.lenght<1)
			  {
				  alert("Introduzca datos, por favor");	 
			  }
			  else if (result.rows.length==1)
			  {
				  alert("Ya ha introducido datos. Pulse Analizar datos para conocer su situacion");
			  }
			  else
			  {
					var sql = "INSERT INTO ingresosgastos (nomina,ingresos,deudas,gastosMes) VALUES (?,?,?,?)";
					transaction.executeSql (sql, [nomina,ingresos,deudas,gastosMes], function ()
					{
					  alert("Sus datos han sido enviados. Pulse analizar datos");
					}, error);
		      }			
	    });			
      });
});


$("#analizar_datos").on("click", function (event)
  {
	$.mobile.changePage($("#analisis"));
	  
	$("#analisis").on("pageshow", function(){
	
		db.transaction (function (transaction) 
		{
			var sql = "SELECT * FROM ingresosgastos";
			transaction.executeSql (sql, undefined,function (transaction, result)
			{
			  if (result.rows.length)
			  {
			 
				for (var i = 0; i < result.rows.length; i++) 
				{
				  var row = result.rows.item(i);
				  nomina = row.nomina;
				  ingresos = row.ingresos;
				  deudas= row.deudas;
				  gastosMes=row.gastosMes;
				  endeuda= Number(nomina)+ Number(ingresos);
				  porEndeuda= Number((deudas/(endeuda))*100).toFixed(0);
				  nivelDeuda="XXX";
				  nivelEndeudamiento="XXX";
				  texto="XXX";
			 
					 if(porEndeuda<15)
					 {
						nivelDeuda="inferior";
						nivelEndeudamiento="bajo";
						texto="Aunque posee un nivel bajo de endeudamiento si quiere puede probar nuestro sistema para comprobar si podemos ayudarle a pagar menos por sus cuotas mensualmente(prestamos, tarjetas, etc). Si lo desea pulse ACEPTAR";
					 }
					 else if (porEndeuda>15 && porEndeuda<35)
					 {
						nivelDeuda="inferior";
						nivelEndeudamiento="aceptable";
						texto="Aunque posee un nivel medio de endeudamiento si quiere puede probar nuestro sistema para comprobar si podemos ayudarle a pagar menos por sus cuotas mensualmente(prestamos, tarjetas, etc). Si lo desea pulse ACEPTAR";
					 }
					 else if (porEndeuda>35 && porEndeuda<40)
					 {
						nivelDeuda="superior";
						nivelEndeudamiento="un poco alto para sus ingresos y puede tener dificultades si pide mÃ¡s prestamos.";
						texto="Ante su nivel de endeudamiento, podemos ayudarle a pagar menos por sus cuotas mensualmente(prestamos, tarjetas, etc). Si lo desea pulse ACEPTAR";
					}
					 else
					{
						nivelDeuda="muy superior";
						nivelEndeudamiento="por encima de lo normal y puede estar pasando por dificultades en estos momentos. Le recomendamos una reestructuracion de su deuda, ampliando plazos, etc. ";
						texto="Ante su nivel de endeudamiento, podemos ayudarle a pagar menos por sus cuotas mensualmente(prestamos, tarjetas, etc). Si lo desea pulse ACEPTAR";
					}
			
					$('#capa1').text("Normalmente las entidades financieras le admiten, y hoy mas que nunca, hasta un 35% o 40% de endeudamiento en el que se incluyen las deudas actuales. Usted tiene actualmente un endeudamiento de un "+(porEndeuda)+"%.").css("font-size","small");
					$('#capa2').text("Actualmente usted puede gastar hasta "+ ((endeuda*.35).toFixed(0)) + " Euros en sus prestamos de coche, casa, tarjetas, deudas con centros comerciales, etc. Y lo que usa actualmente en prestamos es "+ deudas +".").css("font-size","small");
					$('#capa3').text("Su deuda es "+nivelDeuda+" a su nivel de endeudamiento. Por lo tanto, tiene un nivel de deuda "+nivelEndeudamiento+ ".").css("font-size","small");
					$('#capa4').text(texto).css("font-size","small");
			
					 
			
				}
			  }
		  });
		 },error);
      });
	  
	  
	 // $.mobile.changePage($("#analisis"));
	  
	  
	  
	  
});
//}//function onclic even




$("#remove").on("click", function (event)
{
  if (!confirm ("Delete table?", "")) return;
  db.transaction (function (transaction) 
  {
    var sql = "DROP TABLE ingresosgastos";
    transaction.executeSql (sql, undefined, ok, error);
  });
});
function ok (){}
function error (transaction, err) 
{
  return false;
}


  </script>




